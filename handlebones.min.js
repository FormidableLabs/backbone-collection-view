!function(e,t){if("function"==typeof define&&define.amd)define(["underscore","backbone","handlebars","jquery","exports"],function(i,n,r,s,a){e.Handlebones=t(e,a,i,n,r,s)});else if("undefined"!=typeof exports){var i=require("underscore"),n=require("backbone"),r=require("handlebars");t(e,exports,i,n,r)}else e.Handlebones=t(e,{},e._,e.Backbone,e.Handlebars,e.jQuery||e.Zepto||e.ender||e.$)}(this,function(e,t,i,n,r,s){function a(e){return new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)").test(this.className)}function l(e){a.call(this,e)||(this.className=this.className?[this.className,e].join(" "):e)}function h(e){if(a.call(this,e)){var t=this.className,i=new RegExp("(?:^|\\s+)"+e+"(?:\\s+|$)","g");this.className=t.replace(i,"")}}function o(e){e._isReady||e.trigger("ready")}function c(){this._isReady||(this._isReady=!0,i.each(this.children,o),this.listenTo(this,"addChild",o))}function d(){this._renderCount=0,this.children={},I[this.cid]=this,this.listenTo(this,"ready",c)}function u(){this._renderCount||this.render()}function p(e){if(e&&e.string&&(e=e.string),H){if(this._renderCount&&(A||s.fn&&s.fn.jquery))for(;this.el.hasChildNodes();)this.el.removeChild(this.el.childNodes[0]);this.$el.empty(),this.$el.append(e)}else this.el.innerHTML=e}function m(){this.emptyClass&&h.call(this.el,this.emptyClass),this._emptyViewInstance&&(this._emptyViewInstance.remove(),this.removeChild(this._emptyViewInstance)),p.call(this,"")}function f(){this.emptyClass&&l.call(this.el,this.emptyClass),p.call(this,""),this.emptyView&&(this._emptyViewInstance=this._emptyViewTemplate?new(this.emptyView.extend({template:this._emptyViewTemplate})):new this.emptyView,this.addChild(this._emptyViewInstance),this._emptyViewInstance.appendTo(this.el))}function g(){this.itemFilter&&this.collection.forEach(v,this)}function v(e){if(this.itemFilter){var t="["+T+'="'+e.cid+'"]',n=this.el.querySelectorAll(t);i.each(n,function(t){t.style.display=w.call(this,e)?"block":"none"})}}function w(e){return this.itemFilter(e,this.collection.indexOf(e))}function y(e,t,n){if(e.match(/^("|')/)&&e.match(/("|')$/))return e.replace(/(^("|')|('|")$)/g,"");for(var r=e.split("."),s=r.length,a=0;t&&s>a;a++)"this"!==r[a]&&(t=t[r[a]]);return n&&i.isString(t)?encodeURIComponent(t):t}function V(e){e.tag&&(e.tagName=e.tag,delete e.tag),e["class"]&&(e.className=e["class"],delete e["class"])}function _(){var e=this.el.querySelectorAll("["+N+"]");i.each(e,function(e){var t=e.getAttribute(N),i=this.children[t];i&&(u.call(i),e.parentNode.replaceChild(i.el,e))},this)}t.VERSION="0.0.1";var C="data-view-name",b="data-view-cid",x="data-history-link",N="data-view-tmp",T="data-model-cid",I={},E=!!navigator.userAgent.match(/Trident\/7\./),A=E||/msie [\w.]+/.exec(navigator.userAgent.toLowerCase()),H="undefined"!=typeof s&&s.fn,S="undefined"!=typeof Element&&Element.prototype,k=S.addEventListener||function(e,t){return this.attachEvent(e,t)};return t.View=n.View.extend({template:r.VM.noop,render:function(e){var t;return t=i.isFunction(e)?e(this.context()):i.isString(e)?e:this.template(this.context()),p.call(this,t),_.call(this),++this._renderCount,this.trigger("render"),this},context:function(){return this},appendTo:function(e){return u.call(this),i.isFunction(e)?e():H?this.$el.appendTo(e):e.appendChild(this.el),this.trigger("ready",{target:this}),this},addChild:function(e){return this.children[e.cid]?e:(e.parent=this,this.children[e.cid]=e,this.trigger("addChild",e),e)},removeChild:function(e){return delete e.parent,delete this.children[e.cid],this.trigger("removeChild",e),e},remove:function(){delete I[this.cid],this.name&&this.el.removeAttribute(C),this.el.removeAttribute(b);var e=n.View.prototype.remove.apply(this,arguments);return this.trigger("remove"),e},toString:function(){return"[object Handlebones.View."+(this.name||this.cid)+"]"},setElement:function(){var e=n.View.prototype.setElement.apply(this,arguments);return this.name&&this.el.setAttribute(C,this.name),this.el.setAttribute(b,this.cid),e},_ensureElement:function(){return d.call(this),n.View.prototype._ensureElement.call(this)},_onViewHelper:function(e){e.fn&&e.fn!==r.VM.noop&&(this.template=e.fn)}}),t.LayoutView=t.View.extend({render:function(){return++this._renderCount,this.trigger("render"),this},setView:function(e,t){var n,r,s=this._view;return e===s?this:(r=i.bind(function(){s&&(s.remove(),this.removeChild(s))},this),n=i.bind(function(){this._view=e,e&&(u.call(e),this.addChild(e),this._view.appendTo(this.el))},this),t?t(e,s,n,r):(r(),n()),this)},getView:function(){return this._view},_onViewHelper:!1}),t.ItemView=t.View.extend({_ensureElement:function(){var e=t.View.prototype._ensureElement.apply(this,arguments);return this.el.setAttribute(T,this.model.cid),e},context:function(){return this.model.attributes}}),t.CollectionView=t.View.extend({itemView:t.ItemView,emptyView:t.View,emptyClass:"empty",itemFilter:!1,initialize:function(){this.listenTo(this.collection,{reset:"render",sort:"render",change:function(e){v.call(this,e)},add:function(e){1===this.collection.length&&m.call(this);var t=this.collection.indexOf(e);this.appendItem(e,t)},remove:function(e){this.removeItem(e),0===this.collection.length&&f.call(this)}})},render:function(){return 0===this.collection.length?f.call(this):(m.call(this),this.collection.forEach(function(e,t){this.appendItem(e,t)},this)),++this._renderCount,this.trigger("render"),this},appendItem:function(e,t){var n;n=this._itemViewTemplate?new(this.itemView.extend({template:this._itemViewTemplate}))({model:e}):new this.itemView({model:e}),this.addChild(n);var r=t>0?this.collection.at(t-1):!1;if(r){var s="["+T+'="'+r.cid+'"]',a=this.$el.children().last(s);a.after(n.el)}else n.appendTo(i.bind(function(){this.el.parentNode.insertBefore(n.el,this.el.firstChild)},this));return v.call(this,e),this.trigger("appendItem",e,n),this},removeItem:function(e){var t="["+T+'="'+e.cid+'"]',i=this.el.querySelector(t),n=i.getAttribute(b),r=this.children[n];return r.remove(),this.removeChild(r),this.trigger("removeItem",e,r),this},updateFilter:function(){g.call(this)},_onViewHelper:function(e){e.fn&&e.fn!==r.VM.noop&&(this._itemViewTemplate=e.fn),e.inverse&&e.inverse!==r.VM.noop&&(this._emptyViewTemplate=e.inverse)}}),t.Util={tag:function(e,n,s){var a=i.omit(e,"tagName"),l=e.tagName||"div";return"<"+l+" "+i.map(a,function(e,i){var n=e;return s&&(n=t.Util.expandToken(e,s)),n=r.Utils.escapeExpression(n),("className"===i?"class":i)+'="'+n+'"'}).join(" ")+">"+(i.isUndefined(n)?"":n)+"</"+l+">"},expandToken:function(e,t,n){if(e&&e.indexOf&&e.indexOf("{{")>=0){for(var s,a=/(?:\{?[^{]+)|(?:\{\{([^}]+)\}\})/g,l=[],h=function(e){return y(e,t,n)};s=a.exec(e);)if(s[1]){var o=s[1].split(/\s+/);if(o.length>1){var c=o.shift();o=i.map(o,h),l.push(r.helpers[c]?r.helpers[c].apply(t,o):s[0])}else l.push(y(o[0],t,n))}else l.push(s[0]);e=l.join("")}return e}},r.registerHelper("view",function(e,i){if(!e)return"";e._onViewHelper&&e._onViewHelper(i);var n={tagName:e.el.tagName.toLowerCase()};n[N]=e.cid;var s=t.Util.tag(n,"",this);return new r.SafeString(s)}),r.registerHelper("url",function(e){e=e||"";var r;if(r=arguments.length>2?i.map(i.head(arguments,arguments.length-1),encodeURIComponent).join("/"):t.Util.expandToken(e,this,!0),n.history._hasPushState){var s=n.history.options.root;return"/"===s&&"/"===r.substr(0,1)?r:s+r}return"#"+r}),r.registerHelper("link",function(){var e=i.toArray(arguments),n=e.pop(),s=n.hash,a=0===e.length?[s.href]:e;V(s),a.push(n),s.href=r.helpers.url.apply(this,a),s.tagName=s.tagName||"a",s[x]=!0;var l=t.Util.tag(s,n.fn?n.fn(this):"",this);return new r.SafeString(l)}),k.call(document,"readystatechange",function(){"complete"===document.readyState&&k.call(document.body,"click",function(e){if(!e.metaKey&&e.shiftKey){var t=e.target.getAttribute("href");t&&("#"===t[0]||"/"===t[0]&&"/"!==t[1])&&n.history.navigate(t,{trigger:!0})}e.preventDefault?e.preventDefault():e.returnValue=!1})},!1),H&&(s.fn.view=function(){var e="["+b+"]",t=s(this).closest(e);return t&&I[t.attr(b)]||!1}),t});